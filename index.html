<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Room Escape â€“ Hardcore</title>
    <style>
        body { margin: 0; background: #0b0b0b; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; overflow: hidden; }
        canvas { background: #1a1a1a; border: 4px solid #333; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
    </style>
</head>
<body>

<canvas id="game" width="900" height="550"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const player = { x: 0, y: 0, size: 20, speed: 4 };
let level = 0;
let hasKey = false;
let deadFlash = 0;
let frameCount = 0;

const keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

const levels = [
  { start: {x:40,y:40}, key: {x:820,y:60}, door: {x:830,y:420,w:50,h:90}, walls: [{x:400,y:0,w:30,h:400}] },
  
  
  { start: {x:40,y:40}, key: {x:820,y:60}, realKey: {x:60,y:420}, door: {x:830,y:420,w:50,h:90}, mechanics: {fakeKey:true}, walls: [{x:250,y:0,w:20,h:250},{x:250,y:350,w:20,h:200}] },

  { start: {x:40,y:480}, key: {x:450,y:60}, door: {x:830,y:60,w:50,h:90}, walls: [{x:150,y:0,w:20,h:450},{x:300,y:100,w:400,h:20,move:{axis:'y',range:300,speed:3}}] },

 
  { start: {x:50,y:250}, key: {x:800,y:50}, door: {x:850,y:450,w:40,h:80}, mechanics: {pressurePlate:{x:50,y:500,w:40,h:10,active:false}}, walls: [{id:"gate",x:120,y:0,w:20,h:550,isGate:true},{x:400,y:0,w:20,h:300,move:{axis:'y',range:200,speed:4}}] },

  
  { start: {x:40,y:250}, key: {x:820,y:250}, door: {x:40,y:40,w:60,h:60}, traps: [{x:200,y:0,w:80,h:550,type:'pulse',state:0},{x:400,y:0,w:80,h:550,type:'pulse',state:40},{x:600,y:0,w:80,h:550,type:'pulse',state:80}], walls: [] },

  
  { start: {x:40,y:40}, key: {x:40,y:480}, door: {x:830,y:420,w:50,h:90}, walls: [{x:0,y:150,w:750,h:20}, {x:150,y:350,w:750,h:20}, {x:150,y:180,w:30,h:160,move:{axis:'x',range:720,speed:6}}] },
  { start: {x:450,y:500}, key: {x:450,y:40}, door: {x:40,y:500,w:60,h:40}, walls: [{x:0,y:150,w:700,h:20},{x:200,y:300,w:700,h:20},{x:0,y:450,w:700,h:20}] },


  { start: {x:40,y:40}, key: {x:820,y:480}, door: {x:820,y:40,w:50,h:70}, mechanics: {pressurePlate:{x:430,y:260,w:40,h:40,active:false}}, walls: [{x:750,y:0,w:20,h:550,isGate:true},{x:0,y:200,w:400,h:20},{x:500,y:350,w:400,h:20}] },
 


 
  { start: {x:40,y:260}, key: {x:820,y:260}, door: {x:430,y:240,w:40,h:70}, mechanics: {pressurePlate:{x:820,y:40,w:40,h:40,active:false}}, walls: [{x:350,y:150,w:200,h:20,isGate:true},{x:350,y:380,w:200,h:20,isGate:true},{x:350,y:150,w:20,h:250,isGate:true},{x:530,y:150,w:20,h:250,isGate:true}], traps: [{x:0,y:0,w:900,h:100,type:'pulse',state:0},{x:0,y:450,w:900,h:100,type:'pulse',state:0}] }
];

let curLvl = {};
let activeWalls = [];
let activeTraps = [];

function loadLevel() {
    const l = levels[level];
    curLvl = JSON.parse(JSON.stringify(l));
    player.x = l.start.x; player.y = l.start.y;
    hasKey = false;
    activeWalls = curLvl.walls || [];
    activeTraps = curLvl.traps || [];
    activeWalls.forEach(w => { if(w.move) { w.baseX = w.x; w.baseY = w.y; w.curOffset = 0; w.dir = 1; } });
}

function die() { deadFlash = 25; loadLevel(); }

function rectIntersect(r1, r2) {
    return r1.x < r2.x + (r2.w || r2.size) && r1.x + (r1.w || r1.size) > r2.x &&
           r1.y < r2.y + (r2.h || r2.size) && r1.y + (r1.h || r1.size) > r2.y;
}

function update() {
    frameCount++;
    let nx = player.x, ny = player.y;
    if (keys.ArrowUp || keys.w) ny -= player.speed;
    if (keys.ArrowDown || keys.s) ny += player.speed;
    if (keys.ArrowLeft || keys.a) nx -= player.speed;
    if (keys.ArrowRight || keys.d) nx += player.speed;

    const nextP = { x: nx, y: ny, size: player.size };

    for (const w of activeWalls) {
        if (w.move) {
            w.curOffset += w.dir * w.move.speed;
            if (Math.abs(w.curOffset) > w.move.range) w.dir *= -1;
            w.x = w.move.axis === 'x' ? w.baseX + w.curOffset : w.x;
            w.y = w.move.axis === 'y' ? w.baseY + w.curOffset : w.y;
        }
        if (w.isGate && curLvl.mechanics?.pressurePlate?.active) continue;
        if (rectIntersect(nextP, w)) { die(); return; }
    }

    for (const t of activeTraps) {
        if (t.type === 'pulse') {
            if (((frameCount + t.state) % 100 < 50) && rectIntersect(nextP, t)) { die(); return; }
        }
    }

    const pp = curLvl.mechanics?.pressurePlate;
    if (pp && rectIntersect(nextP, pp)) pp.active = true;

    const k = curLvl.key;
    if (!hasKey && rectIntersect(nextP, {x: k.x, y: k.y, size: 16})) {
        if (curLvl.mechanics?.fakeKey) {
            curLvl.key = curLvl.realKey;
            curLvl.mechanics.fakeKey = false;
        } else { hasKey = true; }
    }

    if (hasKey && rectIntersect(nextP, curLvl.door)) {
        level = (level + 1) % levels.length;
        loadLevel(); return;
    }

    player.x = Math.max(0, Math.min(canvas.width - player.size, nx));
    player.y = Math.max(0, Math.min(canvas.height - player.size, ny));
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const pp = curLvl.mechanics?.pressurePlate;
    if (pp) { ctx.fillStyle = pp.active ? "#4ade80" : "#f87171"; ctx.fillRect(pp.x, pp.y, pp.w, pp.h); }

    activeTraps.forEach(t => {
        let active = (frameCount + t.state) % 100 < 50;
        ctx.fillStyle = active ? "rgba(239, 68, 68, 0.5)" : "rgba(239, 68, 68, 0.05)";
        ctx.fillRect(t.x, t.y, t.w, t.h);
    });

    activeWalls.forEach(w => {
        if (w.isGate && curLvl.mechanics?.pressurePlate?.active) {
            ctx.strokeStyle = "#4ade80"; ctx.setLineDash([5, 5]); ctx.strokeRect(w.x, w.y, w.w, w.h); ctx.setLineDash([]);
        } else {
            ctx.fillStyle = w.move ? "#fb923c" : "#64748b"; ctx.fillRect(w.x, w.y, w.w, w.h);
        }
    });

    if (!hasKey) {
        ctx.fillStyle = "#facc15"; ctx.fillRect(curLvl.key.x, curLvl.key.y, 16, 16);
    }

    ctx.fillStyle = hasKey ? "#16a34a" : "#451a03";
    ctx.fillRect(curLvl.door.x, curLvl.door.y, curLvl.door.w, curLvl.door.h);

    ctx.fillStyle = "#4ade80"; ctx.fillRect(player.x, player.y, player.size, player.size);

    ctx.fillStyle = "#fff"; ctx.font = "bold 20px sans-serif";
    ctx.fillText(`LEVEL ${level + 1}`, 20, 35);

    if (deadFlash > 0) {
        ctx.fillStyle = `rgba(255, 0, 0, ${deadFlash/50})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        deadFlash--;
    }
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loadLevel();
loop();
</script>
</body>
</html>